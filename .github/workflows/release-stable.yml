name: Release Stable lib-version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Select the type of version bump (patch, minor, or major)'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          server-id: github

      - name: Create custom settings.xml for GitHub Packages
        run: |
          mkdir -p ~/.m2
          echo "<settings xmlns=\"https://maven.apache.org/SETTINGS/1.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd\">" > ~/.m2/settings.xml
          echo "  <servers>" >> ~/.m2/settings.xml
          echo "    <server>" >> ~/.m2/settings.xml
          echo "      <id>github-releases</id>" >> ~/.m2/settings.xml
          echo "      <username>${{ github.actor }}</username>" >> ~/.m2/settings.xml
          echo "      <password>${{ secrets.GITHUB_TOKEN }}</password>" >> ~/.m2/settings.xml
          echo "    </server>" >> ~/.m2/settings.xml
          echo "  </servers>" >> ~/.m2/settings.xml
          echo "</settings>" >> ~/.m2/settings.xml

      - name: Calculate Stable and Next Snapshot Versions
        id: versions
        env:
          BUMP_TYPE: ${{ inputs.bump_type }}
        run: |
          CURRENT_SNAPSHOT=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          if [[ ! "$CURRENT_SNAPSHOT" =~ -SNAPSHOT$ ]]; then
            echo "Error: The repository version must be a SNAPSHOT (e.g., 1.2.3-SNAPSHOT) before a stable release."
            exit 1
          fi

          BASE_VERSION=$(echo "$CURRENT_SNAPSHOT" | sed 's/-SNAPSHOT$//')
          IFS='.' read -r X Y Z <<< "$BASE_VERSION"
          
          # Perform the bump based on input
          case "$BUMP_TYPE" in
            patch)
              NEW_STABLE="$BASE_VERSION"
              NEXT_SNAPSHOT="$X.$Y.$((Z + 1))-SNAPSHOT"
              ;;
            minor)
              NEW_STABLE="$X.$((Y + 1)).0"
              NEXT_SNAPSHOT="$X.$((Y + 1)).1-SNAPSHOT"
              ;;
            major)
              NEW_STABLE="$((X + 1)).0.0"
              NEXT_SNAPSHOT="$((X + 1)).0.1-SNAPSHOT"
              ;;
            *)
              echo "Invalid bump_type: $BUMP_TYPE"
              exit 1
              ;;
          esac
          
          echo "NEW_STABLE_VERSION=$NEW_STABLE" >> $GITHUB_ENV
          echo "NEXT_SNAPSHOT_VERSION=$NEXT_SNAPSHOT" >> $GITHUB_ENV
          
          echo "Calculated Stable Version: $NEW_STABLE"

      - name: Set Git user for commits
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Set project version in pom.xml (Stable Version)
        run: mvn versions:set -DnewVersion=${{ env.NEW_STABLE_VERSION }}

      - name: Propagate Stable Version to version.properties
        run: mvn process-resources

      - name: Commit version update
        run: |
          cp target/classes/version.properties src/main/resources/version.properties
          git add pom.xml src/main/resources/version.properties
          git commit -m "chore(release): Prepare stable release v${{ env.NEW_STABLE_VERSION }}"

      - name: Tag the release commit
        run: git tag v${{ env.NEW_STABLE_VERSION }}

      - name: Build and Deploy Package
        run: mvn deploy

      - name: Push stable commit and tag (Requires PAT for protected branch)
        run: git push https://github-actions:${{ secrets.PAT_FOR_PUSH }}@github.com/${{ github.repository }} main --tags

      - name: Set next development version
        run: mvn versions:set -DnewVersion=${{ env.NEXT_SNAPSHOT_VERSION }}

      - name: Commit next development version
        run: |
          git add pom.xml
          git commit -m "chore(dev): Set next development snapshot version"
          git push https://github-actions:${{ secrets.PAT_FOR_PUSH }}@github.com/${{ github.repository }} main
